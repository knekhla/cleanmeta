version: '3.8'

services:
  # === Backend Service ===
  app:
    container_name: cleanmeta-app
    build: .
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    env_file:
      - .env
    depends_on:
      - redis
    networks:
      - cleanmeta-net
      - root_default
    labels:
      - "traefik.enable=true"
      # API Routing: Matches /api prefix
      - "traefik.http.routers.cleanmeta-api.rule=Host(`cleanmeta.io`, `www.cleanmeta.io`) && PathPrefix(`/api`, `/health`)"
      - "traefik.http.routers.cleanmeta-api.entrypoints=web,websecure"
      - "traefik.http.routers.cleanmeta-api.tls.certresolver=myresolver"
      - "traefik.http.services.cleanmeta-api.loadbalancer.server.port=3000"
      - "traefik.docker.network=root_default"

  # === Frontend Service ===
  frontend:
    container_name: cleanmeta-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://217.15.171.234:3003
        NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_KEY}
        NEXT_PUBLIC_APP_URL: http://217.15.171.234:3004
    restart: always
    ports:
      - "3004:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://217.15.171.234:3003
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_KEY}
    networks:
      - root_default
    labels:
      - "traefik.enable=true"
      # Web Routing: Matches everything else
      - "traefik.http.routers.cleanmeta-web.rule=Host(`cleanmeta.io`, `www.cleanmeta.io`)"
      - "traefik.http.routers.cleanmeta-web.entrypoints=web,websecure"
      - "traefik.http.routers.cleanmeta-web.tls.certresolver=myresolver"
      - "traefik.http.services.cleanmeta-web.loadbalancer.server.port=3000"
      - "traefik.docker.network=root_default"

  # === Redis Service ===
  redis:
    image: redis:alpine
    container_name: cleanmeta-redis
    restart: always
    networks:
      - cleanmeta-net
    volumes:
      - redis_data:/data

networks:
  cleanmeta-net:
    driver: bridge
  root_default:
    external: true

volumes:
  redis_data:
